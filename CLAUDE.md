# 概要
これは、homebridgeのプラグインです。Echonet Liteプロトコルでエアコンを制御することを目的としています。

# 使用テクノロジー
- TypeScript 5.7.3
- Homebridge 2.0.0-beta.0
- EchoNet-Lite 2.16.3
- homebridge-lib 7.1.4

# プロジェクト構造
- `src/platform.ts`: メインプラットフォーム、EchoNet-Lite通信ロジック
- `src/platformAccessory.ts`: エアコンアクセサリークラス、HomeKit特性ハンドリング
- `src/settings.ts`: プラグイン設定定数
- `src/index.ts`: プラグインエントリポイント

# コーディングルール
TypeScriptのベストプラクティスに従って、以下の要件でAPIクライアントを実装してください：
- 厳密な型定義を使用
- エラーハンドリングの適切な実装
- ジェネリクスを活用した再利用可能な設計
- ESLintとPrettierの設定も含める
- 高い可読性、高い保守性

# 実装の手順
1. 要件定義：必要な機能の洗い出しを行う
2. 設計：機能の実現方式を思考する
3. テスト：テストスクリプトで機能をテストできるようにする。
4. ESLintチェック
5. ビルド
6. コミット：すべてまとめてでなく、変更の意図に合わせてコミットする

# 開発コマンド
- `npm run build`: TypeScriptビルド
- `npm run lint`: ESLintチェック
- `npm run watch`: 開発時の自動ビルド・リンク

# 注意点
- 一つのエアコンに対してステータスと温度の情報を一度に取得しようとすると、タイムアウトしてしまい応答できない。一つずつ順番にメトリクスを取得することが重要。
- デバイス間のリクエストは最低300ms間隔で送信（src/platform.ts:246）
- HomeKit互換性のため、キャッシュ機能を実装（2秒キャッシュ、src/platformAccessory.ts:31）
- タイムアウト設定：EchoNet-Liteリクエストは2秒、HomeKit応答は800ms-1000ms

# リトライ機能
- タイムアウト時の自動リトライ：最大5回（デフォルト）
- 指数バックオフ：500ms → 1s → 2s → 4s → 8s
- 設定可能な項目（config.json内）:
  ```json
  {
    "retry": {
      "maxRetries": 5,
      "baseDelayMs": 500,
      "maxDelayMs": 8000
    }
  }
  ```

# 外部操作の自動反映
- リモコン・本体操作の自動検知：INF通知 + ポーリング
- 検知対象：運転状態、モード、目標温度、現在温度
- ポーリング間隔：60秒（1分、デフォルト、設定可能）
- 設定可能な項目（config.json内）:
  ```json
  {
    "polling": {
      "enabled": true,
      "intervalMs": 60000
    }
  }
  ```
- 推奨設定:
  - INF通知対応デバイス: 60-300秒（1-5分）
  - INF通知非対応デバイス: 30-60秒（30秒-1分）

# データ検証とエラー処理
- EchoNet-Lite特殊値の検出：0xFD（未設定）、0xFE（範囲外）、0xFF（未定義）
- EPC固有の値範囲検証：温度、運転状態、運転モードの妥当性チェック
- HomeKit範囲制限：目標温度10-38°C、現在温度-270-100°C
- 不正値の処理：警告ログ出力後、HomeKit更新をスキップ